<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INE V49 - Editor Definitivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <!-- Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .editor-container {
            height: 60vh;
            min-height: 400px;
            background-color: #020617;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        .loading-overlay {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(4px);
        }
        .valid-badge {
            background-color: #dcfce7; color: #166534; border: 1px solid #166534;
            padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;
            margin-right: 4px; display: inline-block; margin-bottom: 2px;
        }
        .invalid-badge {
            background-color: #fee2e2; color: #991b1b; border: 1px solid #ef4444;
            padding: 2px 6px; border-radius: 4px; font-size: 10px;
            margin-right: 4px; display: inline-block; margin-bottom: 2px; text-decoration: line-through; opacity: 0.7;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 font-sans p-4 min-h-screen flex flex-col">

    <!-- Header -->
    <div class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-lg shrink-0">
        <h1 class="text-lg font-bold text-emerald-400 flex items-center gap-2">
            <i class="fas fa-id-card"></i> Escáner V49
        </h1>
        <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-bold transition-colors shadow-md">
            <i class="fas fa-camera mr-1"></i> NUEVA FOTO
        </button>
        <input type="file" id="fileInput" accept="image/*" class="hidden" />
    </div>

    <!-- VISTA 1: EDITOR (Se muestra al cargar imagen) -->
    <div id="editor-view" class="hidden flex flex-col gap-4 h-full">
        
        <div class="bg-blue-900/30 border-l-4 border-blue-500 p-3 rounded text-xs text-blue-200 flex justify-between items-center shrink-0">
            <span><i class="fas fa-info-circle mr-1"></i> Ajusta el cuadro AZUL a los datos.</span>
            <span id="auto-msg" class="hidden text-emerald-400 font-bold animate-pulse">¡Auto-Detectado!</span>
        </div>

        <div class="editor-container relative group border border-slate-700 w-full">
            <img id="image-to-edit" class="max-w-full block">
        </div>

        <!-- Controles Editor -->
        <div class="grid grid-cols-4 gap-2 shrink-0">
            <button onclick="cropper.rotate(-90)" class="bg-slate-700 text-white p-3 rounded-lg"><i class="fas fa-undo"></i></button>
            <button onclick="cropper.rotate(90)" class="bg-slate-700 text-white p-3 rounded-lg"><i class="fas fa-redo"></i></button>
            <button onclick="cropper.reset()" class="bg-slate-700 text-yellow-400 p-3 rounded-lg"><i class="fas fa-sync"></i></button>
            <button onclick="processCrop()" class="bg-emerald-600 text-white font-bold p-3 rounded-lg shadow-lg flex items-center justify-center gap-2 col-span-1">
                <i class="fas fa-check"></i> LISTO
            </button>
        </div>
        <div class="w-full px-2 shrink-0">
             <input type="range" id="rotate-slider" min="-45" max="45" value="0" class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500">
             <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                 <span>-45°</span><span id="rot-val">0°</span><span>+45°</span>
             </div>
        </div>
    </div>

    <!-- VISTA 2: RESULTADOS (Se muestra al procesar) -->
    <div id="result-view" class="hidden flex flex-col gap-4 h-full">
        
        <div class="bg-white text-slate-900 p-4 rounded-xl shadow-2xl border-t-4 border-emerald-500 flex-grow overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold text-slate-800">Datos Extraídos</h2>
                <button onclick="returnToEditor()" class="text-xs text-blue-600 font-bold underline">
                    <i class="fas fa-arrow-left"></i> Corregir Recorte
                </button>
            </div>
            
            <!-- Formulario -->
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Nombre Completo</label>
                    <input type="text" id="nombre" class="w-full text-lg font-bold p-2 bg-slate-100 border-l-4 border-emerald-500 focus:bg-white outline-none uppercase text-slate-900 transition-all" placeholder="...">
                    <div id="name-badges" class="mt-2 flex flex-wrap gap-1 min-h-[20px]"></div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">CURP</label>
                    <div class="relative">
                        <input type="text" id="curp" maxlength="18" class="w-full font-mono text-xl p-2 bg-slate-100 border-l-4 border-emerald-500 focus:bg-white outline-none uppercase tracking-widest text-slate-900 transition-all" placeholder="------------------">
                        <i id="curp-check" class="fas fa-check-circle absolute right-3 top-3.5 text-emerald-500 text-xl opacity-0 transition-opacity"></i>
                    </div>
                </div>
            </div>

            <!-- Preview Pequeño -->
            <div class="mt-6 pt-4 border-t border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Imagen Procesada:</p>
                <div class="h-24 w-full bg-black rounded overflow-hidden flex justify-center border border-slate-300">
                    <img id="final-preview" class="h-full object-contain">
                </div>
            </div>
            
            <div class="mt-4">
                 <button onclick="document.getElementById('raw-log').classList.toggle('hidden')" class="text-xs text-gray-400 underline">Ver texto crudo</button>
                 <pre id="raw-log" class="hidden text-[9px] font-mono bg-gray-100 p-2 mt-1 rounded text-gray-600 whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>

    <!-- Placeholder Inicial -->
    <div id="placeholder" class="flex flex-col items-center justify-center h-[60vh] text-slate-600 border-2 border-dashed border-slate-700 rounded-xl mt-4">
        <i class="fas fa-image text-6xl mb-4 opacity-30"></i>
        <p class="text-sm font-bold opacity-50">Sube una foto para empezar</p>
    </div>

    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 loading-overlay z-50 flex flex-col items-center justify-center p-4 text-center">
        <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <span class="text-white font-bold text-lg tracking-widest" id="loader-text">PROCESANDO...</span>
        <p class="text-slate-400 text-xs mt-2">Mejorando imagen y leyendo texto</p>
    </div>

    <script>
        let cropper = null;
        let cvReady = false;
        
        const COMMON_NAMES = ["GARCIA","MARTINEZ","LOPEZ","GONZALEZ","RODRIGUEZ","HERNANDEZ","PEREZ","SANCHEZ","RAMIREZ","FLORES","GOMEZ","TORRES","DIAZ","VASQUEZ","CRUZ","MORALES","GUTIERREZ","REYES","RUIZ","JIMENEZ","MENDOZA","AGUILAR","ORTIZ","ALVAREZ","CASTILLO","ROMERO","MORENO","CHAVEZ","RIVERA","RAMOS","JUAN","JOSE","LUIS","MARIA","GUADALUPE","FRANCISCO","ANTONIO","JESUS","MIGUEL","ANGEL","PEDRO","ALEJANDRO","MANUEL","MARGARITA","CARLOS","ROBERTO","FERNANDO","DANIEL","JORGE","RICARDO","EDWIN","ALEXIS","EDUARDO","JAVIER","RAFAEL","MARTIN","RAUL","DAVID","JOSEFINA","VERONICA","ALBERTO","ENRIQUE","GERARDO","MARIO","ARMANDO","SERGIO","GILBERTO","GABRIEL","ANDRES","ADRIAN"];
        const fuse = new Fuse(COMMON_NAMES, { includeScore: true, threshold: 0.35, minMatchCharLength: 3 });

        function onOpenCvReady() { cvReady = true; }

        // --- 1. CARGA Y AUTO-AJUSTE ---
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('editor-view').classList.remove('hidden');
                document.getElementById('result-view').classList.add('hidden');
                
                const image = document.getElementById('image-to-edit');
                image.src = ev.target.result;

                initCropper(image);

                if(cvReady) {
                    setTimeout(() => autoDetectZone(image), 300);
                }
            };
            reader.readAsDataURL(file);
        });

        function initCropper(imageElement) {
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageElement, {
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.5,
                guides: true,
                center: true,
                highlight: false,
                background: false,
                zoomOnWheel: true,
                rotatable: true,
            });

            document.getElementById('rotate-slider').addEventListener('input', function() {
                if(cropper) cropper.rotateTo(parseInt(this.value));
                document.getElementById('rot-val').innerText = this.value + "°";
            });
        }

        // --- 2. AUTO-DETECCIÓN (OPENCV) ---
        function autoDetectZone(imgElement) {
            try {
                let src = cv.imread(imgElement);
                let gray = new cv.Mat();
                let blurred = new cv.Mat();
                let edges = new cv.Mat();

                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                cv.Canny(blurred, edges, 50, 150);

                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let maxArea = 0;
                let bestRect = null;

                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    if (area > 20000) {
                        let rect = cv.boundingRect(cnt);
                        if (rect.width * rect.height > maxArea) {
                            maxArea = rect.width * rect.height;
                            bestRect = rect;
                        }
                    }
                }

                if (bestRect && cropper) {
                    // Lógica: Mitad derecha, un poco abajo
                    cropper.setData({
                        x: bestRect.x + (bestRect.width * 0.28),
                        y: bestRect.y + (bestRect.height * 0.15),
                        width: bestRect.width * 0.68,
                        height: bestRect.height * 0.70
                    });
                    document.getElementById('auto-msg').classList.remove('hidden');
                    setTimeout(() => document.getElementById('auto-msg').classList.add('hidden'), 3000);
                }

                src.delete(); gray.delete(); blurred.delete(); edges.delete(); contours.delete(); hierarchy.delete();
            } catch(e) { console.log("Auto-detect falló", e); }
        }

        // --- 3. PROCESAR ---
        function processCrop() {
            if (!cropper) return;
            
            document.getElementById('loader').classList.remove('hidden');
            const canvas = cropper.getCroppedCanvas({ maxWidth: 2000, imageSmoothingQuality: 'high' });

            // UI Switch
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            
            // Reset fields
            document.getElementById('nombre').value = '';
            document.getElementById('curp').value = '';
            document.getElementById('name-badges').innerHTML = '';
            document.getElementById('curp-check').classList.add('opacity-0');

            document.getElementById('final-preview').src = canvas.toDataURL();
            
            setTimeout(() => enhanceImage(canvas), 200);
        }

        function returnToEditor() {
            document.getElementById('result-view').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
        }

        // --- 4. MEJORA (NITIDEZ NATURAL) ---
        function enhanceImage(sourceCanvas) {
            if (!cvReady) { runOCR(sourceCanvas); return; }

            try {
                let src = cv.imread(sourceCanvas);
                let gray = new cv.Mat();
                
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                let clahe = new cv.CLAHE(3.0, new cv.Size(8, 8));
                clahe.apply(gray, gray);
                
                let dsize = new cv.Size(0, 0);
                cv.resize(gray, gray, dsize, 1.5, 1.5, cv.INTER_CUBIC);

                cv.imshow(createHiddenCanvas(), gray); // Usar canvas temporal
                src.delete(); gray.delete(); clahe.delete();
                
                runOCR();
            } catch (err) {
                runOCR(sourceCanvas);
            }
        }

        function createHiddenCanvas() {
            let c = document.getElementById('cvCanvas');
            if(!c) {
                c = document.createElement('canvas');
                c.id = 'cvCanvas';
                document.body.appendChild(c);
                c.style.display = 'none';
            }
            return c;
        }

        // --- 5. OCR Y EXTRACCIÓN ---
        async function runOCR(fallbackCanvas = null) {
            const element = fallbackCanvas || document.getElementById('cvCanvas');
            const worker = await Tesseract.createWorker('spa', 1);
            await worker.setParameters({ preserve_interword_spaces: '1' });

            const { data: { text } } = await worker.recognize(element);
            await worker.terminate();

            document.getElementById('raw-log').innerText = text;

            const lines = text.split('\n').map(l => l.trim().toUpperCase()).filter(l => l.length > 1);
            let validNameParts = [];
            
            // NOMBRE
            let labelIdx = lines.findIndex(l => l.includes('NOMBRE'));
            let startIdx = (labelIdx !== -1) ? labelIdx + 1 : 0;
            const stopWords = ['DOMICILIO', 'DOMICI', 'CLAVE', 'ELECTORAL', 'MZA', 'LT', 'COL', 'CALLE'];
            let linesRead = 0;

            for (let i = startIdx; i < lines.length; i++) {
                let line = lines[i];
                if (stopWords.some(sw => line.includes(sw)) || /\d/.test(line)) break;

                let words = line.split(' ');
                let hasValid = false;
                words.forEach(w => {
                    let clean = w.replace(/[^A-Z]/g, '');
                    if (clean.length >= 3 && clean.length <= 12) {
                        const res = fuse.search(clean);
                        if (res.length > 0 && res[0].score < 0.4) {
                            validNameParts.push(res[0].item);
                            addBadge(res[0].item, 'valid');
                        } else {
                            validNameParts.push(clean);
                            addBadge(clean, 'invalid');
                        }
                        hasValid = true;
                    }
                });
                if (hasValid) linesRead++;
                if (linesRead >= 3) break;
            }
            document.getElementById('nombre').value = validNameParts.join(' ');

            // CURP
            let fullText = text.replace(/[\n\r]/g, ' ').replace(/\s+/g, ' ');
            let tokens = fullText.split(' ');
            let finalCurp = "";

            for(let t of tokens) {
                let clean = t.replace(/[^A-Z0-9]/g, '');
                if(/^[A-Z]{4}[0-9O]{6}/.test(clean) && clean.length >= 16) {
                    finalCurp = clean.substring(0, 18);
                    break;
                }
            }

            if (finalCurp) {
                let arr = finalCurp.split('');
                [4,5,6,7,8,9,17].forEach(k => { if(arr[k] === 'O') arr[k] = '0'; if(arr[k] === 'I') arr[k] = '1'; });
                finalCurp = arr.join('');
                document.getElementById('curp-check').classList.remove('opacity-0');
            }
            document.getElementById('curp').value = finalCurp;
            document.getElementById('loader').classList.add('hidden');
        }

        function addBadge(text, type) {
            const span = document.createElement('span');
            span.innerText = text;
            span.className = type === 'valid' ? 'valid-badge' : 'invalid-badge';
            document.getElementById('name-badges').appendChild(span);
        }
    </script>
</body>
</html>


    
