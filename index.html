<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OCR INE - Mejorado</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  body{font-family:system-ui,Arial;margin:16px;max-width:800px}
  input,button{padding:8px 12px;margin:6px 0;border-radius:8px}
  #preview{max-width:100%;border-radius:8px;margin-top:8px}
  #progressBar{height:12px;background:#eee;border-radius:8px;overflow:hidden;margin-top:8px}
  #progressBar > div{height:100%;width:0%;background:#6a2fab}
  .card{border:1px solid #ddd;padding:10px;border-radius:10px;margin-top:8px}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
  <h1>OCR INE - prueba</h1>

  <label>Selecciona foto de INE (foto o escaneo):</label><br>
  <input id="file" type="file" accept="image/*"/>

  <div id="progressBar" style="display:none"><div></div></div>
  <div id="status" class="card" style="display:none">Estado</div>

  <img id="preview" alt="preview" style="display:none"/>
  <div class="card">
    <button id="runBtn">Ejecutar OCR</button>
    <button id="resetBtn">Reiniciar</button>
  </div>

  <h3>Texto OCR</h3>
  <textarea id="ocrText" style="width:100%;height:180px"></textarea>

  <h3>Datos extraídos</h3>
  <div id="extracted" class="card">
    <div><strong>Nombre:</strong> <span id="nameVal">-</span></div>
    <div><strong>CURP:</strong> <span id="curpVal">-</span></div>
  </div>

<script>
const fileEl = document.getElementById('file');
const preview = document.getElementById('preview');
const runBtn = document.getElementById('runBtn');
const resetBtn = document.getElementById('resetBtn');
const ocrText = document.getElementById('ocrText');
const status = document.getElementById('status');
const progressBar = document.getElementById('progressBar');
const progressFill = progressBar.querySelector('div');
const nameVal = document.getElementById('nameVal');
const curpVal = document.getElementById('curpVal');

let lastBlob = null;

fileEl.addEventListener('change', async () => {
  const f = fileEl.files[0];
  if(!f) return;
  // show preview
  preview.src = URL.createObjectURL(f);
  preview.style.display = 'block';
  ocrText.value = '';
  status.style.display = 'none';
  // preprocess and save blob for OCR
  lastBlob = await preprocessImage(f);
});

// Preprocess: resize to max 1600px and convert to grayscale + mild binarize
async function preprocessImage(file){
  const imgBitmap = await createImageBitmap(file);
  const maxDim = 1600;
  let w = imgBitmap.width, h = imgBitmap.height;
  if(Math.max(w,h) > maxDim){
    const scale = maxDim / Math.max(w,h);
    w = Math.round(w * scale);
    h = Math.round(h * scale);
  }
  const canvas = new OffscreenCanvas(w,h);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(imgBitmap,0,0,w,h);

  // get image data and convert to grayscale + adaptive-ish threshold
  const id = ctx.getImageData(0,0,w,h);
  const d = id.data;
  // simple contrast stretch + binarize
  for(let i=0;i<d.length;i+=4){
    // grayscale
    const g = Math.round(0.3*d[i] + 0.59*d[i+1] + 0.11*d[i+2]);
    // stretch contrast
    let v = (g - 80) * 1.4 + 80; // simple stretch
    v = Math.max(0, Math.min(255, v));
    // threshold: keep some gray for textured areas
    const thr = v > 140 ? 255 : (v > 90 ? 180 : 0);
    d[i]=d[i+1]=d[i+2]=thr;
  }
  ctx.putImageData(id,0,0);
  const blob = await canvas.convertToBlob({type:'image/png',quality:0.9});
  return blob;
}

runBtn.addEventListener('click', async () => {
  if(!lastBlob){
    alert('Primero selecciona una imagen.');
    return;
  }
  progressBar.style.display='block';
  progressFill.style.width='0%';
  status.style.display='block';
  status.textContent = 'Inicializando worker...';

  try{
    // create worker
    const worker = Tesseract.createWorker({
      logger: m => {
        // show progress (m.progress is fraction; m.status is string)
        if(m.status && m.progress !== undefined){
          const pct = Math.round(m.progress * 100);
          progressFill.style.width = pct + '%';
          status.textContent = `${m.status} — ${pct}%`;
        } else if (m.status) {
          status.textContent = m.status;
        }
        // console.log(m);
      }
    });

    await worker.load();
    // carga idioma spa (puede tardar)
    await worker.loadLanguage('spa');
    await worker.initialize('spa');

    // mejorar por INE: limitar caracteres
    await worker.setParameters({
      tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789ÁÉÍÓÚÑ ',
      preserve_interword_spaces: '1'
    });

    status.textContent = 'Reconociendo texto...';
    const { data } = await worker.recognize(lastBlob);
    ocrText.value = data.text || '';

    // extraer CURP y nombre (may require ajustar según OCR)
    const textUpper = (data.text || '').toUpperCase();
    const curpMatch = textUpper.match(/[A-Z]{4}\\d{6}[HM][A-Z]{5}\\d{2}/);
    const nameMatch = textUpper.match(/NOMBRE:?\\s*([A-Z\\sÁÉÍÓÚÑ]{5,120})/);
    curpVal.textContent = curpMatch ? curpMatch[0] : 'NO DETECTADO';
    nameVal.textContent = nameMatch ? nameMatch[1].trim() : 'NO DETECTADO';

    await worker.terminate();
    status.textContent = 'Listo';
    progressFill.style.width='100%';
  }catch(err){
    console.error(err);
    status.textContent = 'Error: ' + (err.message || err);
    alert('Error durante OCR. Revisa consola o prueba otra imagen (mejor luz, sin reflejos).');
  }
});

resetBtn.addEventListener('click', () => {
  preview.style.display='none';
  fileEl.value='';
  lastBlob = null;
  ocrText.value='';
  nameVal.textContent='-';
  curpVal.textContent='-';
  status.style.display='none';
  progressBar.style.display='none';
});
</script>
</body>
</html>
