<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OCR Demo Mejorado</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #preview { max-width: 300px; margin-top: 10px; }
    textarea { width: 100%; height: 150px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>OCR INE – Versión Mejorada</h2>

  <input type="file" id="fileInput" accept="image/*">
  <br>
  <img id="preview">

  <textarea id="output" placeholder="Texto OCR aquí..."></textarea>

  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      preview.src = URL.createObjectURL(file);

      const img = await createImageBitmap(file);
      const canvas = new OffscreenCanvas(img.width, img.height);
      const ctx = canvas.getContext('2d');

      // Preprocesamiento suave: escala gris + contraste
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        let avg = (data[i] + data[i+1] + data[i+2]) / 3;
        avg = avg > 120 ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = avg;
      }
      ctx.putImageData(imageData, 0, 0);

      const processedBlob = await canvas.convertToBlob();

      const worker = await Tesseract.createWorker("spa", 1, {
        tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ",
        preserve_interword_spaces: "1",
        load_system_dawg: "F",
        load_freq_dawg: "F"
      });

      const { data: { text } } = await worker.recognize(processedBlob);
      await worker.terminate();

      output.value = text;
    });
  </script>
</body>
</html>